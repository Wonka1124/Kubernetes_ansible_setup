# RKE2 Ansible Playbook

## Описание

Этот playbook предназначен для автоматизированного развертывания кластера Kubernetes (RKE2) на нескольких серверах с помощью Ansible.  
Включает подготовку серверов, установку RKE2, настройку kube-vip, добавление агентов и серверов, а также применение дополнительных манифестов (например, metallb).

---

## Требования

- **Ansible** (рекомендуется последняя версия)
- **Python** (3.6+)
- SSH-доступ к целевым серверам под пользователем с sudo-правами
- На целевых серверах должен быть открыт доступ по SSH

---

## Установка зависимостей

Установите необходимые коллекции Ansible:
```bash
ansible-galaxy collection install -r collections/requirements.yaml
```

---

## Настройка

1. **Инвентори**

   Отредактируйте файл `inventory/hosts.ini`, указав IP-адреса и имена пользователей для ваших серверов и агентов.  
   Пример:
   ```
   [servers]
   server1 ansible_host=192.168.3.21
   server2 ansible_host=192.168.3.22
   server3 ansible_host=192.168.3.23

   [agents]
   agent1 ansible_host=192.168.3.24
   agent2 ansible_host=192.168.3.25

   [rke2:children]
   servers
   agents

   [rke2:vars]
   ansible_user=ansible
   ```

2. **Переменные**

   Отредактируйте файл `inventory/group_vars/all.yaml` под свои нужды:
   - `vip` — виртуальный IP для kube-vip
   - `metallb_version`, `lb_range`, `lb_pool_name` — параметры для metallb
   - (опционально) раскомментируйте и измените версии и директории для компонентов

   Пример:
   ```yaml
   vip: 192.168.3.50
   metallb_version: v0.13.12
   lb_range: 192.168.3.80-192.168.3.90
   lb_pool_name: first-pool
   ```

---

## Запуск

Перейдите в папку с playbook:

```bash
cd Ansible/Playbooks/RKE2
```

Запустите основной playbook:

```bash
ansible-playbook -i inventory/hosts.ini site.yaml
```

---

## Что делает playbook

- Подготавливает все узлы (обновление, установка зависимостей)
- Загружает и устанавливает RKE2
- Настраивает kube-vip для виртуального IP
- Добавляет серверы и агентов в кластер
- Применяет дополнительные манифесты (например, metallb)

---

## Важно

- Перед запуском убедитесь, что у вас есть SSH-доступ ко всем серверам из инвентори.
- Пользователь должен иметь права sudo.
- Проверьте и настройте переменные в `group_vars/all.yaml` под свою инфраструктуру.

---

## Улучшения и TODO

- Поддержка разных ОС и архитектур
- Поддержка нескольких CNI
- Улучшение логики ожидания и проверки статусов
- Оптимизация структуры ролей и задач

---

